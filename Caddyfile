# Production configuration
astrooverz.com, www.astrooverz.com {
    encode zstd gzip

    @api path /api/* /healthz /api/healthz
    reverse_proxy @api backend:8000

    # Bot detection for prerendering
    @bots {
        header User-Agent "*bot*"
        header User-Agent "*crawler*"
        header User-Agent "*spider*"
        header User-Agent "*scraper*"
        header User-Agent "Googlebot*"
        header User-Agent "Bingbot*"
        header User-Agent "Slurp*"
        header User-Agent "DuckDuckBot*"
        header User-Agent "Baiduspider*"
        header User-Agent "YandexBot*"
        header User-Agent "facebookexternalhit*"
        header User-Agent "Twitterbot*"
        header User-Agent "LinkedInBot*"
        header User-Agent "WhatsApp*"
        header User-Agent "TelegramBot*"
        header User-Agent "ChatGPT-User*"
        header User-Agent "GPTBot*"
        header User-Agent "CCBot*"
        header User-Agent "anthropic-ai*"
        header User-Agent "Claude-Web*"
        header User-Agent "PerplexityBot*"
        header User-Agent "YouBot*"
        header User-Agent "Mozilla/5.0 (compatible; Google-Extended)"
        header User-Agent "Mozilla/5.0 (compatible; Bard)"
    }

    # Prerender for bots
    @prerender {
        not path /api/*
        not path /healthz
        not path /robots.txt
        not path /sitemap.xml
        not path *.css
        not path *.js
        not path *.png
        not path *.jpg
        not path *.jpeg
        not path *.gif
        not path *.ico
        not path *.svg
        not path *.woff
        not path *.woff2
        not path *.ttf
        not path *.eot
    }

    # Route bots to prerenderer
    handle @bots @prerender {
        reverse_proxy prerender:3000
        header Cache-Control "public, max-age=3600"
    }

    # Regular users get the frontend
    handle @prerender {
        reverse_proxy frontend:80
        header Cache-Control "public, max-age=300"
    }

    # Fallback for all other requests
    handle {
        reverse_proxy frontend:80
    }

    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# Local development configuration
localhost, 127.0.0.1 {
    encode zstd gzip

    @api path /api/* /healthz /api/healthz
    reverse_proxy @api backend:8000

    # If frontend is its own container
    reverse_proxy frontend:80

    # Optional: security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# Development configuration
:80, :443 {
  # Enable compression
  encode zstd gzip

  # Security headers (relaxed for development)
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remove server information
    -Server
  }

  # API routes - proxy to backend
  @api path /api/*
  handle @api {
    # Add CORS headers for API
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Handle preflight requests
    @options method OPTIONS
    handle @options {
      respond "" 200
    }
    
    # Proxy to backend
    reverse_proxy backend:8000 {
      health_uri /healthz
      health_interval 30s
      health_timeout 5s
    }
    
    # API-specific headers (no caching in development)
    header Cache-Control "no-cache, no-store, must-revalidate"
    header Pragma "no-cache"
    header Expires "0"
  }

  # Static assets (minimal caching in development)
  @static path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
  handle @static {
    reverse_proxy frontend:5173
    header Cache-Control "public, max-age=300"  # 5 minutes in development
    header Vary "Accept-Encoding"
  }

  # Frontend routes - serve static files
  handle {
    reverse_proxy frontend:5173 {
      health_uri /
      health_interval 30s
      health_timeout 5s
    }
    
    # Frontend caching (minimal in development)
    header Cache-Control "public, max-age=60"  # 1 minute in development
    header Vary "Accept-Encoding"
  }
}