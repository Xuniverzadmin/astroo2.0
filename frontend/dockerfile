# -------- Build stage --------
FROM node:20 AS build
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ .
RUN npm run build

# -------- Serve stage (nginx) --------
FROM nginx:alpine
# Copy the Vite build
COPY --from=build /app/dist /usr/share/nginx/html

# Simple SPA fallback so React Router works
RUN printf 'server {\n\
    listen 80;\n\
    server_name _;\n\
    root /usr/share/nginx/html;\n\
    location / {\n\
        try_files $uri /index.html;\n\
    }\n\
}\n' > /etc/nginx/conf.d/default.conf


# 1) Install deps cleanly
COPY frontend/package*.json ./
RUN npm ci

# 2) Copy source (NOT node_modules)
COPY frontend/ ./

# 3) Accept Vite API URL at build time
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL

# 4) Ensure all bin scripts are executable (fixes "Permission denied")
RUN chmod -R +x node_modules/.bin

# 5) Build
RUN npm run build

# --- Runtime: serve static files with nginx ---
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html

# Copy custom nginx configuration
COPY frontend/nginx.conf /etc/nginx/nginx.conf

# Expose port 80
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
